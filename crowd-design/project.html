<template name="project">
  {{> decisionsList}} {{> freeformSketch}}
  <!--  <a href="/projects/{{_id}}/chart" style="float: left; clear: both; margin-top: 50px;">Go to design</a>-->
</template>

<!--RATIONALE AND GOAL -->

<template name="decisionsList">
  <div id="decisionArea">
    <span id="decisionHelpMessage">Decision points for {{name}}:</span>
    <form class="animated fadeIn new-decision" style="float: left; clear: both;">
      <input type="text" name="text" class="decisionLinkForm" placeholder="new decision point" />
    </form>
    <div id="decisions">
      {{#sortable items=decisions options=decisionOptions}}
        {{> decisionBox}}
      {{/sortable}}
    </div>
    {{#if decisions.count}}
    <img src="/barshadow.png" class="decisionShadow"> {{/if}}
  </div>

  <style>
    #decisionArea {
      display: block;
      float: left;
      width: 467px;
      margin-left: 150px;
    }
    
    #decisionHelpMessage {
      margin-top: 100px;
      margin-bottom: 90px;
      display: block;
      font-family: "Avenir Next";
      text-transform: uppercase;
      letter-spacing: 3px;
      font-size: 13px;
      float: left;
    }
    
    .decisionShadow {
      position: absolute;
      left: 50px;
      bottom: 55px;
      opacity: 0.2;
    }
    
    .new-decision {
      float: left;
      clear: both;
      border: 1px solid #d64f2f;
      width: 467px;
      margin-bottom: 10px;
    }
    
    .decisionLinkForm {
      width: 467px;
      text-align: center;
      display: block;
      font-family: "Avenir Next";
      color: white;
      letter-spacing: 1px;
      font-size: 19px;
      -webkit-font-smoothing: subpixel-antialiased;
      background-color: transparent;
      border: none;
      padding-top: 17px;
      padding-bottom: 17px;
      outline: none;
    }
    
    #decisions {
      height: 760px;
      width: 467px;
      overflow-y: scroll;
      display: block;
      float: left;
    }
    
    .decisionBox {
      float: left;
      clear: both;
      background-color: #d64f2f;
      width: 467px;
      margin-top: 10px;
    }
    
    .decisionName {
      width: 467px;
      text-align: center;
      display: block;
      font-family: "Avenir Next";
      color: white;
      letter-spacing: 1px;
      font-size: 19px;
      -webkit-font-smoothing: subpixel-antialiased;
    }
    
    .delete {
      position: absolute;
      margin-left: -68px;
      margin-top: -8px;
      padding-left: 30px;
      padding-top: 30px;
      padding-right: 30px;
      padding-bottom: 30px;
      font-family: "Avenir Next";
      color: white;
      -webkit-font-smoothing: antialiased;
      opacity: 0;
    }
    
    .delete:hover {
      opacity: 1;
    }
    
    .decisionDetails {
      float: left;
      display: block;
      border: 1px solid #d64f2f;
      width: 465px;
      height: 90px;
    }
    
    .rationale {
      display: block;
      float: left;
      /*      background-color: peru;*/
      
      margin-left: 10px;
      margin-top: 5px;
    }
    
    .uppercaseSubHeading {
      font-family: "Avenir Next";
      text-transform: uppercase;
      letter-spacing: 2px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .rationaleBox {
      width: 400px;
      height: 44px;
      margin-top: 6px;
      display: block;
      resize: none;
      background-color: transparent;
      border: 1px solid white;
      outline: none;
    }
  </style>

</template>

<template name="decisionBox">
  <div class="decisionContainer">
    <div class="decisionBox animated fadeIn">
      <p class="decisionName" style="float: left;">{{name}}</p>
      <span style="float: right;" class="delete">&#10006;</span>
    </div>
    <div class="decisionDetails">
      <span class="rationale">
        <span class="uppercaseSubHeading">rationale and goal:</span>
      <form class="rationaleForm">
        <textarea class="rationaleBox" placeholder="Click to type! (Autosaves)">{{rationale}}</textarea>
      </form>
      </span>
    </div>
  </div>

  <script>
    // collapse decision details
    $(document).find('.decisionDetails').css('display', 'none');
  </script>


</template>

<template name="freeformSketch">
  <div id="practiceSketchArea">
    <span id="practiceSketchHelpMessage" class="uppercaseHeading">SKETCH IDEAS ANYWHERE BELOW<br></span>
    <!-- ><span style="opacity: 0.3;">DOUBLE-CLICK TO CLEAR</span></!-->
    <canvas id="practiceSketch" width="1200" height="3000"></canvas>
    <span id="practiceSketchToolbar">
      <img class="practiceTool colorSelector selectedTool" src="/palette-white.png" data-color="#FFF">
      <img class="practiceTool colorSelector" src="/palette-black.png" data-color="#202020">
      <img class="practiceTool colorSelector" src="/palette-ocean.png" data-color="#80D4FC">
      <img class="practiceTool colorSelector" src="/palette-green.png" data-color="#6AB373">
      <img class="practiceTool colorSelector" src="/palette-orange.png" data-color="#DE8A6E">
      <img class="practiceTool colorSelector" src="/palette-yellow.png" data-color="#E9BB35">
      <img class="practiceTool eraserTool" src="/eraser.png">
      <img class="practiceTool undoSelector toolWithMargin" src="/undo.png">
      <img class="practiceTool redoSelector" src="/redo.png">
      <span class="practiceTool clearSelector uppercaseHeading toolWithMargin">CLEAR</span>
    </span>

    <script>
      var canvas = new fabric.Canvas('practiceSketch');
      canvas.isDrawingMode = true;
      canvas.freeDrawingBrush.width = 6
      canvas.freeDrawingBrush.color = "white"

      //      fabric.util.addListener(fabric.document, 'dblclick', function () {
      //        canvas.clear().renderAll();
      //      });

      var canvasStateStack = [];
      var canvasRedoStack = [];

      function saveState() {
        console.log("saved state");

        if (canvasStateStack.length == 30) {
          canvasStateStack.shift();
        }
        if (canvasRedoStack.length != 0) {
          canvasRedoStack = [];
        }
        canvasStateStack.push(JSON.stringify(canvas));
      }

      saveState();
      var recordingStates = true;

      canvas.on('object:added', function (e) {
        if (recordingStates) {
          saveState();
        }
      })

      canvas.on('object:modified', function (e) {
        if (recordingStates) {
          saveState();
        }
      })

      canvas.on('object:removed', function (e) {
        if (recordingStates) {
          saveState();
        }
      })

      // selecting colors
      $(".colorSelector").click(function () {
        $("img.selectedTool").removeClass("selectedTool");
        $(this).addClass("selectedTool");
        canvas.freeDrawingBrush.color = this.getAttribute("data-color");
        disableEraser();
      });

      // selecting the eraser
      $(".eraserTool").click(function () {
        $("img.selectedTool").removeClass("selectedTool");
        $(this).addClass("selectedTool");
        enableEraser();
      })

      function disableEraser() {
        canvas.off("mouse:down");
        canvas.isDrawingMode = true;
      }

      function enableEraser() {
        canvas.isDrawingMode = false;
        canvas.on("mouse:down", function (e) {
          if (canvas.getActiveGroup()) {
            recordingStates = false;
            canvas.getActiveGroup().forEachObject(function (a) {
              canvas.remove(a);
            });
            canvas.discardActiveGroup();
            recordingStates = true;
          } else {
            canvas.remove(canvas.getActiveObject());
          }
          canvas.renderAll();
        });
      }

      $(".undoSelector").click(function () {
        if (canvasStateStack.length > 1) {
          recordingStates = false;
          var currentState = canvasStateStack.pop();
          canvasRedoStack.push(currentState);

          var stateToReturnTo = canvasStateStack[canvasStateStack.length - 1];
          canvas.loadFromJSON(stateToReturnTo);
          canvas.renderAll();
          recordingStates = true;
        }
      });

      $(".redoSelector").click(function () {
        if (canvasRedoStack.length > 0) {
          recordingStates = false;
          var stateToReturnTo = canvasRedoStack.pop();
          canvasStateStack.push(stateToReturnTo);
          canvas.loadFromJSON(stateToReturnTo);
          canvas.renderAll();
          recordingStates = true;
        }
      });

      $(".clearSelector").click(function () {
        if (canvas.getObjects().length > 0) {
          canvas.clear().renderAll();
          saveState();
        }
      })







      function showShadow() {
        $(".decisionShadow").isHidden = false;
      }
    </script>

    <style>
      #practiceSketchArea {
        float: right;
        border-left: 1px dotted rgba(255, 255, 255, 0.5);
      }
      
      .uppercaseHeading {
        font-family: "Avenir Next";
        text-transform: uppercase;
        letter-spacing: 3px;
        font-size: 13px;
      }
      
      #practiceSketchHelpMessage {
        margin-top: 100px;
        margin-bottom: -120px;
        margin-right: 100px;
        display: block;
        float: right;
        text-align: right;
      }
      
      #practiceSketch {
        width: 1000px;
        height: 1000px;
        display: block;
      }
      
      #practiceSketchToolbar {
        position: absolute;
        bottom: 100px;
        right: 100px;
        text-align: right;
      }
      
      .practiceTool {
        margin-left: 10px;
      }
      
      .toolWithMargin {
        margin-left: 30px;
      }
      
      .colorSelector,
      .eraserTool {
        opacity: 0.4;
      }
      
      .selectedTool {
        opacity: 1;
        -webkit-filter: drop-shadow(0px 4px 5px rgba(0, 0, 0, 0.1));
      }
      
      .clearSelector {
        display: block;
        float: right;
        margin-top: 4px;
      }
    </style>
  </div>
</template>